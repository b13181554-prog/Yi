# Docker Compose للإنتاج
# دعم ملايين المستخدمين مع Redis Cluster و Auto-scaling
version: '3.8'

services:
  # Redis Cluster - Master Nodes
  redis-master-1:
    image: redis:7-alpine
    container_name: redis-master-1
    ports:
      - "7001:7001"
      - "17001:17001"
    volumes:
      - redis-master-1-data:/data
    command: >
      redis-server 
      --port 7001
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --maxmemory 1gb
      --maxmemory-policy allkeys-lru
    networks:
      - obentchi-network
    restart: unless-stopped

  redis-master-2:
    image: redis:7-alpine
    container_name: redis-master-2
    ports:
      - "7002:7002"
      - "17002:17002"
    volumes:
      - redis-master-2-data:/data
    command: >
      redis-server 
      --port 7002
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --maxmemory 1gb
      --maxmemory-policy allkeys-lru
    networks:
      - obentchi-network
    restart: unless-stopped

  redis-master-3:
    image: redis:7-alpine
    container_name: redis-master-3
    ports:
      - "7003:7003"
      - "17003:17003"
    volumes:
      - redis-master-3-data:/data
    command: >
      redis-server 
      --port 7003
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --maxmemory 1gb
      --maxmemory-policy allkeys-lru
    networks:
      - obentchi-network
    restart: unless-stopped

  # Redis Cluster - Replica Nodes
  redis-replica-1:
    image: redis:7-alpine
    container_name: redis-replica-1
    ports:
      - "7004:7004"
      - "17004:17004"
    volumes:
      - redis-replica-1-data:/data
    command: >
      redis-server 
      --port 7004
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --maxmemory 1gb
      --maxmemory-policy allkeys-lru
    networks:
      - obentchi-network
    restart: unless-stopped

  redis-replica-2:
    image: redis:7-alpine
    container_name: redis-replica-2
    ports:
      - "7005:7005"
      - "17005:17005"
    volumes:
      - redis-replica-2-data:/data
    command: >
      redis-server 
      --port 7005
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --maxmemory 1gb
      --maxmemory-policy allkeys-lru
    networks:
      - obentchi-network
    restart: unless-stopped

  redis-replica-3:
    image: redis:7-alpine
    container_name: redis-replica-3
    ports:
      - "7006:7006"
      - "17006:17006"
    volumes:
      - redis-replica-3-data:/data
    command: >
      redis-server 
      --port 7006
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --maxmemory 1gb
      --maxmemory-policy allkeys-lru
    networks:
      - obentchi-network
    restart: unless-stopped

  # Nginx Load Balancer
  nginx:
    image: nginx:alpine
    container_name: obentchi-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - http-server-1
      - http-server-2
      - http-server-3
    networks:
      - obentchi-network
    restart: unless-stopped

  # HTTP Servers (3 instances للتوزيع)
  http-server-1:
    build:
      context: .
      dockerfile: Dockerfile.http
    environment:
      - NODE_ENV=production
      - PORT=5000
      - REDIS_HOST=redis-master-1
      - REDIS_PORT=7001
      - REDIS_CLUSTER_NODES=redis-master-1:7001,redis-master-2:7002,redis-master-3:7003
      - INSTANCE_ID=1
    networks:
      - obentchi-network
    restart: unless-stopped
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: '2'
          memory: 1G

  http-server-2:
    build:
      context: .
      dockerfile: Dockerfile.http
    environment:
      - NODE_ENV=production
      - PORT=5000
      - REDIS_HOST=redis-master-2
      - REDIS_PORT=7002
      - REDIS_CLUSTER_NODES=redis-master-1:7001,redis-master-2:7002,redis-master-3:7003
      - INSTANCE_ID=2
    networks:
      - obentchi-network
    restart: unless-stopped
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: '2'
          memory: 1G

  http-server-3:
    build:
      context: .
      dockerfile: Dockerfile.http
    environment:
      - NODE_ENV=production
      - PORT=5000
      - REDIS_HOST=redis-master-3
      - REDIS_PORT=7003
      - REDIS_CLUSTER_NODES=redis-master-1:7001,redis-master-2:7002,redis-master-3:7003
      - INSTANCE_ID=3
    networks:
      - obentchi-network
    restart: unless-stopped
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: '2'
          memory: 1G

  # Bot Webhook Workers (متعددة لتحمل الملايين)
  bot-webhook-1:
    build:
      context: .
      dockerfile: Dockerfile.bot
    environment:
      - INSTANCE_ID=1
      - REDIS_CLUSTER_NODES=redis-master-1:7001,redis-master-2:7002,redis-master-3:7003
    networks:
      - obentchi-network
    restart: unless-stopped
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '1'
          memory: 512M

  # Queue Workers (متعددة مع auto-scaling)
  queue-worker-1:
    build:
      context: .
      dockerfile: Dockerfile.queue
    environment:
      - INSTANCE_ID=1
      - REDIS_CLUSTER_NODES=redis-master-1:7001,redis-master-2:7002,redis-master-3:7003
      - QUEUE_CONCURRENCY=50
    networks:
      - obentchi-network
    restart: unless-stopped
    deploy:
      replicas: 5
      resources:
        limits:
          cpus: '2'
          memory: 1G

  # Scheduler (نسخة واحدة فقط)
  scheduler:
    build:
      context: .
      dockerfile: Dockerfile.scheduler
    environment:
      - REDIS_CLUSTER_NODES=redis-master-1:7001,redis-master-2:7002,redis-master-3:7003
    networks:
      - obentchi-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

  # Prometheus Monitoring
  prometheus:
    image: prom/prometheus:latest
    container_name: obentchi-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
    networks:
      - obentchi-network
    restart: unless-stopped

  # Grafana Dashboard
  grafana:
    image: grafana/grafana:latest
    container_name: obentchi-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - obentchi-network
    restart: unless-stopped

networks:
  obentchi-network:
    driver: bridge

volumes:
  redis-master-1-data:
  redis-master-2-data:
  redis-master-3-data:
  redis-replica-1-data:
  redis-replica-2-data:
  redis-replica-3-data:
  prometheus-data:
  grafana-data:
