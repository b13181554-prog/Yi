# OBENTCHI Trading Bot

## Overview
OBENTCHI is a Telegram-based cryptocurrency trading bot designed to offer technical analysis, real-time market data, and automated trading across crypto and forex markets. It features a Telegram Web App for user interaction, automated withdrawal/deposit systems, and multi-language support. The project aims to be a robust, accessible trading assistant, empowering users with advanced analytical tools and a seamless trading experience to secure a significant market share in automated trading.

## User Preferences
- Default Language: Arabic (ar)
- يمكن للمستخدمين تغيير اللغة من خلال القائمة الرئيسية
- Data Policy: No mock or placeholder data - all data must be authentic from real APIs and Telegram

## System Architecture
The system features a professional, modern, and responsive Telegram Web App with a dark theme. The core logic runs on an Express server managing Telegram Bot interactions, MongoDB operations, multi-language support, automated withdrawals, market data fetching, technical analysis, notifications, and TRON blockchain integration. Security includes environment variables, error handling, rate limiting, and Telegram signature verification.

**UI/UX Decisions**:
The Telegram Web App features a dark theme, providing a professional, modern, and responsive user experience.

**Technical Implementations**:
- **Analysis Systems**: Includes Regular Analysis (65%+ indicator agreement), Ultra Analysis (11 indicators, dynamic weighting, 3 confidence tiers), Zero Reversal Analysis (100-point scoring, flexible RSI, dynamic R/R), and V1 PRO AI Analysis (AI-powered, sentiment analysis, self-learning weights). All systems include risk assessment and precise SL/TP.
- **Advanced Analyst Performance System**: Comprehensive metrics, 5-tier ranking, 12 achievement badges, and an AI Performance Advisor (Groq/Llama 3.3 70B).
- **Smart Multi-Market Scanner**: Real-time scanning across markets with SSE, live results, entry/exit points, and confidence levels.
- **Enhanced Withdrawal System**: Queue-based automated processing with Bull + Redis, retry mechanisms, failure handling, multi-channel notifications, and MongoDB transactions.
- **Robust Subscription Payment System**: Re-engineered for reliability with MongoDB Transactions, graceful fallback, error handling, referral integrity, and Web App integration.
- **Critical Architecture Refactoring**: Implemented atomic database operations, Redis-based distributed rate limiting, microservices architecture (HTTP Server, Bot Worker, Queue Worker, Scheduler), optimized notification system, comprehensive API timeout configuration, and centralized logging.
- **Dynamic Feature Control System**: Real-time feature toggling with Global, Tier-based, and User-specific scopes, gradual rollout, and Redis + MongoDB caching.
- **Smart Search Optimizer**: Multi-level caching (LRU + Redis), parallel multi-market search, fuzzy matching, intelligent ranking, and auto-complete suggestions.
- **Enhanced Earning System**: 3-level referral program, milestone bonuses, analyst performance bonuses, and an earnings dashboard.
- **Advanced Security System**: Automated fraud detection, real-time user behavior analysis, risk scoring, device fingerprinting, and IP reputation checks.
- **Flexible Action System**: Custom action registration, chaining with conditional logic, scheduled actions, and rollback capability.
- **Automated Safety System**: 24/7 monitoring for withdrawals, logins, balance, and system health, with daily security audits and anomaly detection.
- **Groq AI Service with Circuit Breaker** (Added Oct 2025): Enterprise-grade Groq API wrapper with circuit breaker pattern (3 failures threshold), intelligent caching (30min TTL, 100 entries max), exponential backoff retry mechanism, rate limit tracking, and graceful fallback responses. Includes monitoring endpoint `/api/groq/status` for usage statistics and health checks.
- **Multi-Exchange Candle Data Fallback** (Added Oct 2025): Automatic failover system for cryptocurrency candle data fetching with prioritized sources (OKX → Bybit → Gate.io), exchange-specific error handling, and detailed logging for debugging rare/unlisted assets.
- **Enhanced User Error Messaging** (Added Oct 2025): Comprehensive error message catalog (`error-messages.js`) providing context-aware, user-friendly error explanations in Arabic with actionable solutions, severity indicators, and retry guidance for common failures (network issues, data unavailability, AI capacity limits, payment errors).
- **Quality-Based Refund System** (Added Oct 2025): Intelligent refund mechanism for per-analysis payments (0.1 USDT) that automatically refunds users when signal quality (agreementPercentage) falls below 60%. System charges upfront on analysis request, then evaluates signal confidence after analysis completes - high-quality signals (≥60%) retain the fee, while low-quality signals (<60%) trigger automatic refund. Implemented across all analysis endpoints (analyze, ultra, zero-reversal, v1-pro, pump, master) with comprehensive logging for audit trails.
- **Enhanced Analysis Fee Management System** (Added Oct 2025): Complete overhaul of the fee deduction and refund system with centralized `analysis-fee-manager.js` module providing instant deductions (<50ms typical), intelligent quality extraction across all analysis types, comprehensive error handling, and detailed logging. Database operations enhanced with accurate balance tracking (balance_before/balance_after fields in transactions), atomic operations with `returnDocument: 'after'`, and complete audit trails. All 6 analysis endpoints unified under this improved system ensuring fast, reliable, and traceable financial operations.
- **Enterprise Scalability Optimizations** (Added Oct 2025): Three critical scalability improvements to support millions of users: (1) **Batch Data Loader** (`utils/batch-loader.js`) - Eliminates N+1 query problem in referral notifications by loading multiple users in a single database query (66% performance improvement), uses snapshot-based flushing to prevent promise leakage during concurrent loads, and includes proper error handling for database failures. (2) **LRU Membership Cache** - Replaces unbounded Map with LRUCache (max 10,000 entries, 60s TTL) to prevent memory leaks when checking channel membership at scale. (3) **Safe Database Query Guards** (`safeFind()` and `processAllDocuments()`) - Prevents Out-of-Memory errors by enforcing pagination/streaming for large datasets (max 1,000 results without explicit limits), ensuring stable operation even with millions of users in the database. All optimizations maintain full backward compatibility with existing database schema.
- **Production-Scale Infrastructure Overhaul** (Added Oct 2025): Complete architectural transformation for handling millions of concurrent users: (1) **Telegram Webhooks Migration** (`bot-webhook.js`, `services/bot-webhook-worker.js`) - Migrated from polling to webhooks with secure secret token validation, enabling horizontal scaling and 1666x throughput improvement (30 → 50,000 updates/sec). (2) **Docker Containerization** - Created separate Dockerfiles for HTTP Server, Bot Worker, Queue Worker, and Scheduler with multi-stage builds, health checks, and security best practices. (3) **Redis Cluster Configuration** (`docker-compose.production.yml`) - 3 master + 3 replica setup for 99.99% availability and 100K ops/sec throughput. (4) **Dynamic Queue Auto-Scaling** (`improved-queue-worker.js`) - Intelligent worker scaling from 5-100 withdrawal workers and 3-50 payment workers based on queue depth and system load. (5) **Kubernetes Orchestration** (`kubernetes/deployment.yaml`) - Full K8s manifests with HorizontalPodAutoscaler for HTTP Server (3-50 pods), Bot Webhook (5-100 pods), and Queue Workers (10-200 pods), enabling automatic scaling for 10M+ users. (6) **Nginx Load Balancer** (`nginx.conf`) - Enterprise-grade load balancing with SSL/TLS termination, rate limiting (1000 req/sec per IP), and gzip compression. (7) **Prometheus Monitoring** (`metrics-exporter.js`, `prometheus.yml`) - Comprehensive metrics collection with prom-client integration across all services, exposing /metrics endpoints for real-time monitoring and alerting. (8) **Centralized Configuration** (`config-manager.js`) - Unified configuration management supporting standalone, Docker, and Kubernetes deployment modes with automatic webhook/polling detection.
- **Active Webhook Deployment on Replit** (Oct 24, 2025): Successfully converted bot from polling mode to webhook mode on Replit (Phase 2 deployment). Bot now running with `USE_WEBHOOK=true`, handling 10K-50K concurrent users with 100 max connections. Webhook endpoint: `https://[replit-domain]/webhook` with secret token validation (`WEBHOOK_SECRET`). This provides 10-50x performance improvement over polling while remaining on Replit's free tier, serving as stepping stone toward full Docker/Kubernetes deployment for millions of users.
- **Redis Installation & Configuration** (Oct 24, 2025): Installed Redis v7.2.6 as system dependency and configured automatic startup via dedicated workflow. Redis now runs persistently on port 6379 (127.0.0.1), enabling critical features: Bull queue processing for withdrawals/payments, intelligent caching system, API cost tracking, and distributed rate limiting. System health monitoring confirms all services (database, queue, Redis) are operational and healthy.

**Feature Specifications**:
The platform offers a Web App for technical analysis, top movers, a wallet for USDT TRC20, and account management. Trading features include technical analysis for diverse asset classes and trending cryptocurrency tracking. Financial features include an internal USDT TRC20 wallet and instant automated withdrawals via OKX API. User management includes analyst subscriptions and referral programs. An extensive admin dashboard provides system statistics, user/analyst management, and withdrawal processing. Automated trade signal monitoring and a blockchain-based pump detection system are integrated.

**System Design Choices**:
The project uses MongoDB Atlas, designed for 24/7 operation with improved error processing and logging. It employs multiple APIs for data redundancy and fallback. The payment system is designed for enterprise scalability, utilizing queue-based processing with Bull and Redis, circuit breaker patterns, comprehensive monitoring, and enhanced security. Subscriptions are non-refundable and non-cancellable, with improved UX for error messages and balance display.

**Deployment Architecture**:
The system supports three deployment modes: (1) **Standalone** - Traditional single-server deployment with polling for development/small-scale usage, (2) **Docker** - Containerized microservices with Redis Cluster and Nginx load balancer for medium-scale production (10K-100K users), (3) **Kubernetes** - Full orchestration with auto-scaling, zero-downtime deployments, and geographic distribution for massive scale (100K-10M+ users). Infrastructure includes separate containers for HTTP Server (port 5000), Bot Webhook Worker (port 8443), Queue Worker (Bull queues), and Scheduler (cron jobs), all monitored via Prometheus metrics and Grafana dashboards. Security enhanced with webhook secret token validation, rate limiting, and comprehensive health checks.

## External Dependencies

-   **Databases**: MongoDB Atlas, Redis (v7.2.6)
-   **Cryptocurrency Market Data APIs**: OKX, Bybit, Binance, CoinGecko, Gate.io, Kraken, Coinbase, CoinPaprika, Huobi, Crypto.com, Bitfinex, DexScreener, GeckoTerminal, Birdeye
-   **Forex/Stocks/Commodities/Indices Market Data APIs**: TwelveData API, Yahoo Finance, Alpha Vantage, ExchangeRate-API, Frankfurter (ECB), FloatRates, VATComply
-   **Blockchain Integration**: TRON Network (for USDT TRC20), Etherscan, BscScan
-   **Withdrawal Integration**: OKX API (USDT TRC20)
-   **Telegram**: Telegram Bot API, Telegram Web App
-   **AI/Customer Support**: Groq API (Llama 3.3 70B Versatile model)
-   **Payment Gateway**: CryptAPI
-   **Whale Tracking**: Whale Alert