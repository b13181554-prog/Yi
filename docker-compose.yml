# Docker Compose للتطوير
# لتشغيل جميع الخدمات محلياً
version: '3.8'

services:
  # Redis - Cache & Queue Backend
  redis:
    image: redis:7-alpine
    container_name: obentchi-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - obentchi-network
    restart: unless-stopped

  # HTTP Server (API)
  http-server:
    build:
      context: .
      dockerfile: Dockerfile.http
    container_name: obentchi-http
    ports:
      - "5000:5000"
    environment:
      - NODE_ENV=production
      - PORT=5000
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MONGODB_URI=${MONGODB_URI}
      - MONGODB_USER=${MONGODB_USER}
      - MONGODB_PASSWORD=${MONGODB_PASSWORD}
      - MONGODB_CLUSTER=${MONGODB_CLUSTER}
      - BOT_TOKEN=${BOT_TOKEN}
      - OWNER_ID=${OWNER_ID}
      - CHANNEL_ID=${CHANNEL_ID}
      - CHANNEL_USERNAME=${CHANNEL_USERNAME}
      - WEBAPP_URL=${WEBAPP_URL}
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - obentchi-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

  # Bot Webhook Worker (يمكن توسيعه لعدة نسخ)
  bot-webhook:
    build:
      context: .
      dockerfile: Dockerfile.bot
    container_name: obentchi-bot-webhook
    ports:
      - "8443:8443"
    environment:
      - NODE_ENV=production
      - BOT_WEBHOOK_PORT=8443
      - PUBLIC_URL=${PUBLIC_URL}
      - WEBHOOK_URL=${WEBHOOK_URL}
      - INSTANCE_ID=1
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MONGODB_URI=${MONGODB_URI}
      - MONGODB_USER=${MONGODB_USER}
      - MONGODB_PASSWORD=${MONGODB_PASSWORD}
      - MONGODB_CLUSTER=${MONGODB_CLUSTER}
      - BOT_TOKEN=${BOT_TOKEN}
      - OWNER_ID=${OWNER_ID}
      - CHANNEL_ID=${CHANNEL_ID}
      - CHANNEL_USERNAME=${CHANNEL_USERNAME}
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - obentchi-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # Queue Worker
  queue-worker:
    build:
      context: .
      dockerfile: Dockerfile.queue
    container_name: obentchi-queue
    environment:
      - NODE_ENV=production
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MONGODB_URI=${MONGODB_URI}
      - MONGODB_USER=${MONGODB_USER}
      - MONGODB_PASSWORD=${MONGODB_PASSWORD}
      - MONGODB_CLUSTER=${MONGODB_CLUSTER}
      - BOT_TOKEN=${BOT_TOKEN}
      - OWNER_ID=${OWNER_ID}
      - OKX_API_KEY=${OKX_API_KEY}
      - OKX_SECRET_KEY=${OKX_SECRET_KEY}
      - OKX_PASSPHRASE=${OKX_PASSPHRASE}
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - obentchi-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

  # Scheduler
  scheduler:
    build:
      context: .
      dockerfile: Dockerfile.scheduler
    container_name: obentchi-scheduler
    environment:
      - NODE_ENV=production
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MONGODB_URI=${MONGODB_URI}
      - MONGODB_USER=${MONGODB_USER}
      - MONGODB_PASSWORD=${MONGODB_PASSWORD}
      - MONGODB_CLUSTER=${MONGODB_CLUSTER}
      - BOT_TOKEN=${BOT_TOKEN}
      - OWNER_ID=${OWNER_ID}
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - obentchi-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

networks:
  obentchi-network:
    driver: bridge

volumes:
  redis-data:
    driver: local
